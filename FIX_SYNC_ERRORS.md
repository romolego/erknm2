# Исправление ошибок синхронизации

## Проблема

При массовой загрузке мета-XML файлов сервер закрывает соединения:
- `RemoteDisconnected('Remote end closed connection without response')`
- `Read timed out. (read timeout=30)`

## Что было исправлено

### 1. Добавлен retry механизм
- До 5 попыток с экспоненциальной задержкой (2, 4, 8, 16, 32 секунды)
- Автоматический retry при ошибках соединения

### 2. Улучшены таймауты
- Connect timeout: 10 секунд
- Read timeout: 60 секунд (для мета-XML), 300 секунд (для ZIP)

### 3. Добавлены задержки между запросами
- 1 секунда между запросами мета-XML
- Предотвращает перегрузку сервера

### 4. Использование сессии с keep-alive
- Переиспользование соединений
- Заголовки для имитации браузера

### 5. Проверка уже скачанных файлов
- Если файл уже существует, используется локальная копия
- Обработка уже скачанных мета-XML файлов

## Обработка уже скачанных файлов

Если мета-XML файлы уже скачаны, но не обработаны, выполните:

```bash
python process_existing_files.py
```

Этот скрипт:
1. Найдет все мета-XML файлы в папке `downloads/meta/`
2. Обработает их и загрузит данные в БД
3. Скачает и обработает ZIP-архивы

## Повторный запуск синхронизации

Теперь при повторном запуске синхронизации:
- Уже скачанные мета-XML файлы будут использованы
- Ошибки соединения будут автоматически повторяться
- Задержки предотвратят перегрузку сервера

## Рекомендации

1. **Запустите обработку существующих файлов:**
   ```bash
   python process_existing_files.py
   ```

2. **Затем запустите синхронизацию снова** через веб-интерфейс или CLI:
   ```bash
   python -m erknm.cli sync-cmd
   ```

3. **Если ошибки продолжаются**, увеличьте задержки в `erknm/sync/synchronizer.py`:
   ```python
   time.sleep(2.0)  # Вместо 1.0
   ```







