# Промпт для продолжения работы в новом чате

## Контекст проекта

Разрабатывается робот сбора и инкрементальной загрузки открытых данных ФГИС ЕРКНМ в PostgreSQL. Проект на Python с использованием Playwright для браузерной автоматизации.

## Текущая проблема

При массовой загрузке мета-XML файлов сервер принудительно разрывает соединения:
- `ConnectionResetError(10054, 'Удаленный хост принудительно разорвал существующее подключение')`
- Прямые HTTP-запросы через `requests` блокируются сервером

## Текущее состояние

### Что уже работает:
1. ✅ Скачивание `list.xml` через Playwright (браузерная автоматизация) - работает
2. ✅ Парсинг `list.xml` - работает
3. ✅ Создание записей о наборах данных в БД - работает
4. ✅ База данных инициализирована - работает
5. ✅ Веб-интерфейс запущен на http://localhost:5000 - работает

### Что НЕ работает:
- ❌ Скачивание мета-XML файлов через прямые HTTP-запросы (`requests.get`) - сервер блокирует
- ❌ Обработка наборов данных останавливается на этапе скачивания мета-XML

## Требуемое решение

**Нужно переделать скачивание мета-XML файлов с использования `requests` на браузерную автоматизацию через Playwright**, аналогично тому, как это сделано для `list.xml`.

### Текущая реализация (НЕ работает):
```python
# erknm/parser/meta_parser.py
def download_meta_xml(url: str, output_path: Path, ...):
    response = requests.get(url, timeout=...)  # Прямой HTTP-запрос - блокируется
    output_path.write_bytes(response.content)
```

### Нужная реализация (как для list.xml):
```python
# Нужно использовать Playwright для имитации человеческого поведения:
# 1. Открыть страницу с мета-XML
# 2. Дождаться загрузки
# 3. Скачать файл через браузер
# 4. Сохранить локально
```

## Структура проекта

```
ERKNM/
├── erknm/
│   ├── browser/
│   │   └── downloader.py  # Скачивание list.xml через Playwright - РАБОТАЕТ
│   ├── parser/
│   │   ├── list_parser.py  # Парсинг list.xml - РАБОТАЕТ
│   │   └── meta_parser.py  # Скачивание мета-XML - НЕ РАБОТАЕТ (использует requests)
│   ├── sync/
│   │   └── synchronizer.py  # Основной модуль синхронизации
│   └── ...
├── downloads/
│   ├── list.xml  # Уже скачан
│   └── meta/  # Папка для мета-XML (пустая, файлы не скачиваются)
└── ...
```

## Что нужно сделать

1. **Создать новый модуль** `erknm/browser/meta_downloader.py` для скачивания мета-XML через Playwright
2. **Изменить** `erknm/parser/meta_parser.py` - убрать `requests.get`, использовать Playwright
3. **Изменить** `erknm/sync/synchronizer.py` - использовать новый метод скачивания
4. **Добавить задержки** между запросами для имитации человеческого поведения (3-5 секунд)
5. **Обработать ошибки** и добавить retry механизм

## Пример URL мета-XML

Мета-XML файлы доступны по ссылкам вида:
- `https://proverki.gov.ru/blob/opendata/7710146102-inspection-2025-9.xml`
- `https://proverki.gov.ru/blob/opendata/7710146102-plan-2025.xml`

Эти ссылки находятся в `list.xml` в атрибуте `link` каждого `item`.

## Текущий код для справки

### erknm/browser/downloader.py (работающий пример)
Использует Playwright для скачивания list.xml:
- Открывает страницу `https://proverki.gov.ru/portal/public-open-data`
- Находит кнопку "Скачать"
- Скачивает файл через браузер
- Сохраняет локально

### erknm/parser/meta_parser.py (текущая проблема)
Использует `requests.get()` - блокируется сервером.

## Требования к решению

1. Использовать Playwright для всех HTTP-запросов к proverki.gov.ru
2. Имитировать человеческое поведение:
   - Открыть страницу
   - Дождаться загрузки
   - Скачать файл
   - Задержки между запросами (3-5 секунд)
3. Сохранить существующую логику обработки
4. Добавить retry механизм для ошибок браузера
5. Логировать все операции

## Дополнительная информация

- Проект использует Python 3.13
- Playwright уже установлен и работает
- База данных PostgreSQL настроена и работает
- Веб-интерфейс доступен на http://localhost:5000
- Все зависимости установлены

## Задача

Переделать скачивание мета-XML файлов с использования `requests` на браузерную автоматизацию через Playwright, чтобы обойти блокировку сервера и имитировать человеческое поведение.








